{% extends 'Juegos-Multimedia/bodyList.html' %}
{#{% extends 'crud/bodyFormCrispy.html' %}#}

{% load static %}

{% load crispy_forms_tags %}


{#{% block headScriptsForm %}#}
{#    <script src="{% static 'js/syncfusion.js' %}"></script>#}
{#    <script src="{% static 'js/util_dev.js' %}"></script>#}
{#    <script src="{% static 'lib/adminlte-3.1.0/plugins/jquery/jquery.min.js' %}"></script>#}
{#    <script src="{% static 'js/gen_actividad_archivo.js' %}"></script>#}
{#{% endblock %}#}

{% block headScripts %}

{% endblock %}


{% block contentForm %}

{% endblock %}

{% block content %}
    <div class="card">
        <div class="card-header">
            <h3 class="card-title"><b>{{ page_title }}</b></h3>
            <div class="card-tools">

{#                {% if url_form_add and permisos == 1 %}#}

                    <a href="{{ url_form_add }}" class="btn btn-outline-primary btn-sm" style="width: 100px;">
                        <i class="fas fa-file-medical"></i> Agregar
                    </a>
{#                {% endif %}#}
            </div>
        </div>
        <!-- /.card-header -->
        <div class="card-body">
            <table id="{{ datatable_id }}"
                   class="table table-sm table-hover table-bordered table-striped dataTable dtr-inline"
                   style="border-collapse: collapse; border-radius: 0.5em; overflow: hidden;">
                <thead>
                <tr>
                    {% if url_form_edit %}
                        <th style="text-align:center"></th>
                    {% endif %}
                    {% if url_form_print %}
                        <th style="text-align:center"></th>
                    {% endif %}
                    {% for field in show_fields %}
                        <th style="font-size: .85rem!important; text-align:center; ">
                            {% get_verbose_field_name object_list.model field %}
                        </th>
                    {% endfor %}
                        <th style="font-size: .85rem!important; text-align:center; width: 100px">
                            Imagen
                        </th>
                </tr>
                </thead>
                <tbody>
                {% for obj in object_list %}
                    <tr>
                        {% if url_form_edit %}
                            <td style="text-align:center; vertical-align: middle; padding: 2px 8px;">
                                <a href="{% url url_form_edit obj.pk %}">
                                    <img id ="icono_editar" src="{% static '/img/list-edit-pencil.png' %}" alt="Edit"
                                         class="table-edit-pencil"></a>
                            </td>
                        {% endif %}
                        {% if url_form_print %}
                            <td style="text-align:center; vertical-align: middle; padding: 8px 12px;">
                                <a id="{{ obj.pk }}" href="#" onClick="downloadReport('{{ obj.pk }}')">
                                    <i class="fas fa-download"></i>
                                </a>
                            </td>
                        {% endif %}
                        {% for field in show_fields %}
                            <td style="font-size: .86rem!important; vertical-align: middle; padding: 8px 12px;">
                                {% setvar show_fields|get_value_from_dict:field as field_method %}
                                {% if field_method is None %}
                                    {{ obj|get_object_attr:field }}
                                {% else %}
                                    {{ obj|get_object_attr:field_method }}

                                {% endif %}
                            </td>
                        {% endfor %}
                    <!-- Agrega una celda para la ruta del archivo multimedia -->
                <td style="font-size: .86rem!important; vertical-align: middle; padding: 8px 12px;">
                    <img src="{{obj.ruta_archivo }}" alt="{{ obj.alt }}" style="width: 60px; height: auto; max-width: 100%;">
                </td>
                    </tr>
                {% endfor %}
                </tbody>
                <tfoot>
                            {% block tabfooter %}
                {% endblock %}
                </tfoot>
            </table>
        </div>
        <!-- /.card-body -->
    </div>
    {% block contentList %}
    {% endblock %}

{% endblock %}

{% block bodyFooterScriptsForm %}
    {# Convierte el grid de texto a un json para maniuplarlo #}
    {{ grids_detalles|json_script:"gr_dets" }}

    <script>
        const gr_dets = get_json_from_script();
        const elem_respuestas = gr_dets[0];
        {#const elem_multimedia = gr_dets[1];#}
        console.log(elem_respuestas);
        //para eliminar y cambiar el estado en un campo de la grid segun corresponda
        eval("elem_respuestas.gridOptions.toolbarClick=" + elem_respuestas.gridOptions.toolbarClick);
        eval("elem_respuestas.gridOptions.rowDataBound=" + elem_respuestas.gridOptions.rowDataBound);
        console.log("Aqui ESTOY11");
        //Inicializa el grid (Detalle)
        var grid = [];
        ej.grids.Grid.Inject(ej.grids.Edit);
        {#const grid = new ej.grids.Grid(elem_unimeds.gridOptions);#}

        grid[0] = new ej.grids.Grid(elem_respuestas.gridOptions);
        grid[0].appendTo("#" + elem_respuestas.grid_id);
        console.log("Aqui ESTOY22");

        $("form#form_Gen_SesionJuegoForm_id button[type = 'submit']").click(function (e) {
            e.preventDefault();
            btnClicked = $(this).attr("name");
            {#alert(btnClicked);#}
            form = document.querySelector('#form_Gen_SesionJuegoForm_id');
            fields = new FormData(form);
            fields.append(btnClicked, '');
            fields.append(elem_respuestas.grid_id, JSON.stringify(elem_respuestas.gridOptions.dataSource));
            {#fields.append(elem_multimedia.grid_id, JSON.stringify(elem_multimedia.gridOptions.dataSource));#}
            sendToServer(url = form.action, data = fields, method = form.method)
                .then(data => {
                    console.log(data)
                    //recupera los errores ya mostrados en pantalla
                    let elms = document.querySelectorAll("[id='error']");
                    let elements = document.getElementsByClassName('is-invalid');
                    //borrar los errores en pantalla
                    for (let i = 0; i < elements.length; i++) {
                        document.getElementById(elements[i].id).classList.remove('is-invalid');
                        console.log("Aqui ESTOY33");
                    }
                    // si la data = 1 significa que la petición no tiene errores

                    if (data.a != 1) {
                        for (let i = 0; i < elms.length; i++) {
                            elms[i].parentNode.removeChild(elms[i]); //borra los errores en pantalla
                            console.log("Aqui ESTOY44");
                        }
                        imprimir_errores(data); //muestra los errores en pantalla
                    } else {
                        window.location.replace("{{url_list}}"); //redirecciona
                        console.log("Aqui ESTOY55");
                    }
                });
        });
        console.log("Aqui ESTOY66");


        var cancelBtn = document.getElementById("cancel_id");

        // Agregar el evento de clic al botón
        cancelBtn.addEventListener("click", function (event) {
            // Prevenir el comportamiento predeterminado de navegación
            {#event.preventDefault();#}
            // Mostrar el mensaje de alerta
            if (contador > 0) {
                for (var i = 0; i < arreglo.length; i++) {
                    {#alert(arreglo[i]);#}
                    $.ajax({
                        type: "POST",
                        url: '/200/delete_file/',
                        // headers: {
                        //     'X-CSRFToken': csrfToken
                        // },
                        data: {
                            file_url: arreglo[i],
                        },
                        success: function (response) {
                            console.log('SE ELIMINO ');


                            // console.log(uploaded_file_url);
                            // ruta_archivo = response.uploaded_file_url;
                            // console.log(ruta_archivo);
                        },
                        error: function (error) {
                            console.log('fuenomasgg');
                            console.log(error);
                        }
                    });
                }
            }


        });
    </script>



{% endblock %}


